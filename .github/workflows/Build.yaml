name: Build OpenGL Project

on:
  workflow_dispatch:

  push:
    branches:
      - testci
  pull_request:
    branches:
      - testci

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install Visual Studio Build Tools
      shell: powershell
      run: |
        Invoke-WebRequest -Uri https://aka.ms/vs/17/release/vs_buildtools.exe -OutFile vs_buildtools.exe
        Start-Process -Wait -NoNewWindow -FilePath "vs_buildtools.exe" -ArgumentList "--quiet", "--wait", "--norestart", "--nocache", "--add Microsoft.VisualStudio.Workload.VCTools"

    - name: Build project
      run: |
        cd cw
        "C:\\Program Files\\Microsoft Visual Studio\\2022\\BuildTools\\MSBuild\\Current\\Bin\\MSBuild.exe" ./cw.sln /p:Configuration=Release


  build-ubuntu:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake libgl1-mesa-dev libxinerama-dev libwayland-dev libxkbcommon-dev libxcursor-dev libxi-dev

    - name: Configure and Build
      run: |
        cd cw
        mkdir -p build
        g++ main.cpp ./src/glad.c -std=c++20 -Iincludes -Llib -lglfw3 -lGL -ldl -o build/GuestLiangOpenGLcw

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: GuestLiangOpenGLcw
        path: cw/build/GuestLiangOpenGLcw

